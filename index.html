<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>title</title>

    <script src="https://code.jquery.com/jquery-1.10.2.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.4/lodash.min.js"></script>

    <script src="data.js"></script>
   
    <style type="text/css">

        .original {
            color: black
        }

        .new {
            color: red
        }

        .removed {
            color: grey;
            text-decoration: line-through;
        }

        .accepted {
            color: orange
        }
        
    </style>

</head>
  
  <body>
  
    <button id="iterate">iterate</button>
    <button id="undo">undo</button>
    <button id="redo">redo</button>
    <select id="replace_insert">
            <option value="replace">replace</option>
            <option value="insert-retain">insert (retain)</option>
            <option value="insert">insert</option>
          </select>

    <div id="current_text">hey</div>

    <script>

        var undo_states = []
        var redo_states = []

        var state = { current_words: [],
                      fragment_range: null }

        var options = {
            mode: "replace",
            fragment_min_length: 5,
            fragment_max_length: 7,
            main_sonnet: 1
        } 

        state.current_words = sonnets[options.main_sonnet].map(word => { return { word, status: "original"} } )

        function get_outside_occurences (word) {
            // searches all _other_ sonnets for a word
            // format for results is an array [ <sonnet index>, <word_index> ]
            
            var others = _.without(sonnets, sonnets[options.main_sonnet])
            result = []
            others.forEach( (s,si) => {
                s.forEach( (w,wi) => {
                    if (word == w) result.push([sonnets.indexOf(s), wi])
                })
            })

            console.log(result)

            return result
        }

        function get_fragment(location, length) {
            var sonn = sonnets[location[0]]
            
            return sonn.slice(location[1], location[1] + length)    
        }

        function get_random_fragment (word) {
            var occurences = get_outside_occurences (word)
            if (occurences.length == 0) return null
            return get_fragment( _.sample( occurences ), _.random(options.fragment_min_length, options.fragment_max_length))
        }

        function replace_n_at(fragment, index, n) {
            var removed = state.current_words.splice(index, n, ...fragment)
            removed = removed.slice().map( word => { return { word: word.word, status: "removed" }})
            state.current_words.splice(index+fragment.length, 0, ...removed)
        }

        function replace_at(fragment, index) {
            replace_n_at(fragment, index, fragment.length)
        }

        function insert_at (fragment, index, retain) {
            replace_n_at(fragment, index, (retain) ? 0 : 1)
        }

        function iterate() {
            var fragment = null, spot
            while (!fragment) {
                spot = _.random(0, state.current_words.length - 1)
                fragment = get_random_fragment( state.current_words[spot].word )
            }

            fragment = fragment.map(word => { return { word, status: "new" }})
    
            switch(options.mode) {
                case "replace" : 
                replace_at(fragment, spot)
                break

                case "insert-retain" :
                insert_at(fragment, spot, true)
                break

                case "insert" :
                insert_at(fragment, spot, false)
            }

            state.fragment_range = [spot, spot + fragment.length - 1]   
        }

        function render() {
            console.log(state.current_words)

            var words = state.current_words.map( (word, i) => 
                '<span class="' + word.status + '">' + word.word + '</span>')
            $("#current_text").html(_.chunk(words, 10).map(line => line.join(" ") + "<br>")) 
        }

        function forward() {
            undo_states.push(_.cloneDeep(state))
            iterate()
            render(state)
        }

        function undo() {
            if (undo_states.length > 0) {
                redo_states.push(state)
                state = undo_states.pop()
                render(state)
            }
        }

        function redo() {
            if (redo_states.length > 0) {
                undo_states.push(_.cloneDeep(state))
                state = redo_states.pop()
                render(state)
            }
        }

        $("#iterate").click(function() {
            forward()
        })

        $("#undo").click(function() {
            undo()
        })

        $("#redo").click(function() {
            redo()
        })

        $("#replace_insert").change( (e) => {
            options.mode = $(e.target).val()
        })

        render()

    </script>

  </body>
</html>